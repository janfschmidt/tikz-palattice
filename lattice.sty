% draw accelerator lattices
% with pgf/tikz
%
% by Jan Schmidt <schmidt@physik.uni-bonn.de>
%
% for up-to-date manual see texlattice_manual.pdf (generated from texlattice_manual.org)
%
% usage:
%  -----
% * lattice environment with 4 optional arguments:
%   1. [tikz options] give any options for the tikzpicture (e.g. overlay)
%   2. [scale] scale whole picture
%   3. [label fontsize] text label fontsize (default \normalsize)
%   4. [label distance] distance of text labels to elements (default 1cm)
%  -----
% * within lattice environment:
% ** elements:
%   - \drift{length/m}[name (default: none)]
%   - \dipole{name}{length/m}{bending angle/deg}[thickness (default 8mm)]
%   - \quadrupole{name}{length/m}
%   - \kicker{name}{length/m}
%   - \cavity{name}{length/m}
%   - \source{name}
%   - \screen{name}
%   - \marker{name}[height/m (default )] a line perpendicular to beamline of given length/height
% ** other commands:
%   - \rotate{angle/deg} "bends" the beamline. e.g. to set starting angle
%   - \shiftlabels moves labels to other side of elements (swap with marker labels)
%   - \start{coordinate/m} sets starting point of lattice. use before first element
%      coordinate in form (x,y) or any tikz label, e.g. (mylabel.east)
%      hint: use with \savecoordinate to connect lattices! (compile twice!)
%   - \drawrule{start coordinate/m}{tick distance/m} a rule to visualize lattice size.
%      coordinate in form (x,y) or any tikz label, e.g. (mylabel.east)
%   - \setdriftcolor{color (default black)} for all following drifts
%   - \setmarkercolor{color (default red)} for all following markers
%   - \setelementcolor{type}{color (default depends on type)} define color for one element-type
% ** to add something manually:
%   - \savecoordinate{name}[position (default: east)] save coordinate of previous element
%      to access it later. you can use all tikz/pgf commands within lattice environment.
%      You can also connect multiple lattices. use tikz overlay option (1. argument of lattice)
%      position specifies the exact place of the element (north, center, south west, ...).
%      Here east is always downstream and west upstream.
%      ! DON'T use bare numbers as names - e.g. (1). These are the internal identifiers.
%      hint: use with \start to connect lattices! (compile twice!)
%  -----
%  * lengths are set in meter, so you write {1.32} for 1.32m.
%  * picture scale: for lattice scale=1 an element of 1m length is plotted with 2cm length
%  * minimum element length 0.01m (drifts can be shorter)
%  * maximum drift length <2.9m (just add a second drift to get a longer one)
%


\RequirePackage{tikz,pgf}
\RequirePackage{ifthen}
\RequirePackage{siunitx}
\RequirePackage{xargs}
\usetikzlibrary{shapes}


\newcommand{\setelementcolor}[2]{\tikzset{#1/.append style={bottom color=#2}}}
\newcommand{\setdriftcolor}[1]{\tikzset{drift/.append style={fill=#1}}}
\newcommand{\setmarkercolor}[1]{\tikzset{marker/.append style={#1}}}

\newcommand{\rotate}[1]{\pgfmathsetmacro{\angle}{\angle+#1};}
\newcommand{\start}[1]{%
  \tikzset{x=2cm,y=2cm}
  \node (0) [start] at #1 {};
  \tikzset{x=1cm,y=1cm}
}

\newcommand{\shiftlabels}{%
\ifthenelse{\labelang = -90}{%
\def\labelang{+90} \def\marklabelang{-90}}{%
\def\labelang{-90} \def\marklabelang{+90}}}

\newcommandx{\savecoordinate}[2][2=east]{\coordinate (#1) at (\i.#2);}

\newcommandx{\drawrule}[2][2=1]{%
  \tikzset{x=2cm,y=2cm}
  \node (rule1) [rule,minimum width=10*#2*20cm] at #1 {};
  \tikzset{x=1cm,y=1cm}
  \node (rule2) [rule,fill=white,minimum width=10*#2*20cm] at (rule1.east) {};
  \node (rule3) [rule,minimum width=10*#2*20cm] at (rule2.east) {};
  \draw [black, thick] (rule1.west) --+ (-90:1mm); % half length
  \draw [black, thick] (rule1.west) --+ (90:1mm);
  \foreach \x in {1,2,3} {%
    \pgfmathsetmacro{\len}{#2*\x}
    \path [draw=none] (rule\x.south east) --+ (-90:0.06*\labeldist/\scal) node[label, anchor=center]
    {\SI[zero-decimal-to-integer]{\len}{\meter}};
    \draw [black,thick] (rule\x.east) --+ (-90:1mm); % half length
    \draw [black,thick] (rule\x.east) --+ (90:1mm);
  }
}

\newcommand{\elementlabel}[1]{%
\pgfmathtruncatemacro\iang{\angle}
\def\labelanchor{north};
\ifthenelse{\labelang = -90}{%
  \ifthenelse{\iang > 30}{\def\labelanchor{west}}{}
  \ifthenelse{\iang > 150}{\def\labelanchor{south}}{}
  \ifthenelse{\iang > 210}{\def\labelanchor{east}}{}
  \ifthenelse{\iang > 330}{\def\labelanchor{north}}{}
}{%
  \ifthenelse{\iang > 30}{\def\labelanchor{east}}{}
  \ifthenelse{\iang > 150}{\def\labelanchor{north}}{}
  \ifthenelse{\iang > 210}{\def\labelanchor{west}}{}
  \ifthenelse{\iang > 330}{\def\labelanchor{south}}{}
}
\path [draw=none] (\j.center) --+ (\angle\labelang:\labeldist) node[label] {#1};}



%lattice environment
\newenvironmentx{lattice}[4][1=, 2=1, 3=\normalsize, 4=7mm]{%
%begin
\tikzpicture[node distance=0mm, remember picture, #1]
\newdimen\labeldist
\newdimen\corners;
\newdimen\dipheight;
\newdimen\markerlen;
\pgfmathsetmacro{\scal}{#2*0.1};
\def\labelfont{#3};
\def\labelang{-90};
\def\marklabelang{+90};
\pgfmathsetlength{\labeldist}{10*\scal*#4};
\pgfmathtruncatemacro{\i}{0};
\pgfmathsetmacro{\angle}{0};
\node (\i) [start] at (0,0) {};
}{%
%end
\endtikzpicture
}


% ----- element commands -----
% drift
\newcommandx{\drift}[2][2=]{%
\pgfmathtruncatemacro{\j}{\i+1};
\node (\j) [drift,minimum width=10*#1*20cm] at (\i.east) {};
\elementlabel{#2};
\pgfmathtruncatemacro{\i}{\j};
}

%dipole
\newcommandx{\dipole}[4][4=8mm]{%
\pgfmathsetmacro{\angle}{\angle+0.5*#3};
\pgfmathtruncatemacro{\j}{\i+1};
\pgfmathsetlength{\corners}{(#2)>=0.4 ? (1mm*10*\scal) : 0mm};
%\pgfmathsetlength{\dipheight}{#3*(12cm/90)+3cm};
\pgfmathsetlength{\dipheight}{10*#4};
\node (\j) [dipole, minimum width=#2*20cm] at (\i.east) {};
\elementlabel{#1};
\pgfmathtruncatemacro{\i}{\j};
\pgfmathsetmacro{\angle}{\angle+0.5*#3};
}

%quadrupole
\newcommand{\quadrupole}[2]{%
\pgfmathtruncatemacro{\j}{\i+1};
\pgfmathsetlength{\corners}{(#2)>=0.4 ? (1mm*10*\scal) : 0mm};
\node (\j) [quadrupole, minimum width=#2*20cm] at (\i.east) {};
\elementlabel{#1};
\pgfmathtruncatemacro{\i}{\j};
}

%kicker
\newcommand{\kicker}[2]{%
\pgfmathtruncatemacro{\j}{\i+1};
\pgfmathsetlength{\corners}{(#2)>=0.4 ? (1mm*10*\scal) : 0mm};
\node (\j) [kicker, minimum width=#2*20cm] at (\i.east) {};
\elementlabel{#1};
\pgfmathtruncatemacro{\i}{\j};
}

%cavity
\newcommand{\cavity}[2]{%
\pgfmathtruncatemacro{\j}{\i+1};
\pgfmathsetlength{\corners}{(#2)>=0.4 ? (1mm*10*\scal) : 0mm};
\node (\j) [cavity, minimum width=#2*20cm] at (\i.east) {};
\elementlabel{#1};
\pgfmathtruncatemacro{\i}{\j};
}

%source
\newcommand{\source}[1]{%
\pgfmathtruncatemacro{\j}{\i+1};
\pgfmathsetlength{\corners}{1mm};
\node (\j) [source, minimum width=10cm] at (\i.east) {};
\elementlabel{#1};
\pgfmathtruncatemacro{\i}{\j};
}

%screen
\newcommand{\screen}[1]{%
\pgfmathtruncatemacro{\j}{\i+1};
\pgfmathsetlength{\corners}{0mm};
\node (\j) [screen, minimum width=4cm] at (\i.east) {};
\elementlabel{#1};
\pgfmathtruncatemacro{\i}{\j};
}

%marker
\newcommandx{\marker}[2][2=0.7]{%
\pgfmathsetlength{\markerlen}{#2*10cm*\scal};
\pgfmathtruncatemacro\iang{\angle}
\def\labelanchor{south};
\ifthenelse{\marklabelang = +90}{%
  \ifthenelse{\iang > 30}{\def\labelanchor{east}}{}
  \ifthenelse{\iang > 150}{\def\labelanchor{north}}{}
  \ifthenelse{\iang > 210}{\def\labelanchor{west}}{}
  \ifthenelse{\iang > 330}{\def\labelanchor{south}}{}
}{%
  \ifthenelse{\iang > 30}{\def\labelanchor{west}}{}
  \ifthenelse{\iang > 150}{\def\labelanchor{south}}{}
  \ifthenelse{\iang > 210}{\def\labelanchor{east}}{}
  \ifthenelse{\iang > 330}{\def\labelanchor{north}}{}
}
\draw [marker] (\i.east) --+ (\angle-90:\markerlen); % half length (=> 10cm)
\draw [marker] (\i.east) --+ (\angle+90:\markerlen);
\draw [draw=none] (\i.east) --+ (\angle\marklabelang:\markerlen+0.5*\labeldist) node[label] {#1};
}


% ----- styles -----
%element (for all, except drift)
\tikzset{element/.style={
rectangle,rounded corners=\corners,
line width=0.8pt*10*\scal, draw=black,
top color=white, bottom color=blue,
anchor=west,
scale=\scal,
rotate=\angle
}}

%dipole
\tikzset{dipole/.style={
element,
minimum height=\dipheight,
}}

%quadrupole
\tikzset{quadrupole/.style={
element,
bottom color=yellow, 
minimum height=10cm,
}}

%kicker
\tikzset{kicker/.style={
element,
bottom color=orange!90!black, 
minimum height=4cm,
}}

%cavity
\tikzset{cavity/.style={
element,
bottom color=brown, 
minimum height=8cm,
}}

%source
\tikzset{source/.style={
element,
regular polygon,regular polygon sides=3, shape border rotate=30,
bottom color=gray, 
minimum height=8cm,
}}

%screen
\tikzset{screen/.style={
element,
forbidden sign,
bottom color=white, 
minimum height=4cm,
}}



%drift
\tikzset{drift/.style={
scale=0.1*\scal,
rectangle,
fill=black,
anchor=west,
minimum height=4cm,
rotate=\angle}}

%text label
\tikzset{label/.style={
text=black,
font=\labelfont,
anchor=\labelanchor
}}

%marker (line)
\tikzset{marker/.style={
red, densely dashed
}}

%rule
\tikzset{rule/.style={
scale=0.1*\scal,
rectangle, draw=black,
fill=black,
anchor=west,
minimum height=6cm/(10*\scal)
}}

%start
\tikzset{start/.style={%
draw=none,
anchor=center,
scale=0.1}}
