\documentclass[a4paper]{scrartcl}
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{fixltx2e}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage[normalem]{ulem}
\usepackage{amsmath}
\usepackage{textcomp}
\usepackage{marvosym}
\usepackage{amssymb}
\usepackage[colorlinks]{hyperref}
\usepackage{siunitx}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{tikz-palattice}
\tolerance=1000

\newcommand{\option}[1]{{\color{red}$\langle$\textit{#1}$\rangle$}}
\newcommand{\optiondef}[2]{{\color{orange!90!black}$\langle$\textit{#1=#2}$\rangle$}}
\newcommand{\tikzlabel}{Ti\textit{k}Z}

\author{Jan Schmidt <schmidt@physik.uni-bonn.de>}
\date{v2.1 (printed \today)}
\title{tikz-palattice - draw particle accelerator lattices with \tikzlabel}
\begin{document}

\lstset{
basicstyle=\small\sffamily,
backgroundcolor=\color{gray!20},
%numbers=left,
numberstyle=\tiny,
breaklines=true,
%frame=l,
xleftmargin=\parindent,
columns=fullflexible,
showstringspaces=false,
keywordstyle=\bfseries\color{green!40!black},
commentstyle=\itshape\color{purple!40!black},
identifierstyle=\color{blue},
stringstyle=\color{orange},
escapeinside={(*}{*)}
}

\maketitle
\textbf{GENERAL INFO TEXT AND LICENSE}
You can even connect lattices to draw injection/extraction or a complete accelerator
facility.

\begin{figure}[h]
  \centering
  \includegraphics[width=1.1\textwidth]{elsa.pdf}
  \caption{The Electron Stretcher Facility ELSA at Bonn University, drawn with
    tikz-palattice}
\label{fig:elsa}
\end{figure}


\clearpage
\tableofcontents

\section{Installation}
\label{sec-1}
\subsection{Copy tikz-palattice.sty}
\label{sec-1-1}
You just need to copy the lattice.sty file to a place where your \LaTeX{} installation can recognize it.
This can be
\begin{itemize}
\item the same folder as your .tex document or
\item in the \LaTeX{} system or user tree.
\end{itemize}
E.g. to add it to the system tree for texlive under ubuntu:
\begin{lstlisting}
sudo mkdir -p /usr/local/share/texmf/tex/latex/lattice/
sudo cp lattice.sty /usr/local/share/texmf/tex/latex/lattice/
sudo mktexlsr
\end{lstlisting}
For this path there is also a Makefile prepared, so just enter
\begin{lstlisting}
sudo make install
\end{lstlisting}
Otherwise read the documentation of your \LaTeX{} distribution.

\subsection{Required packages}
\label{sec-1-2}
\begin{itemize}
\item tikz, pgf
\item siunitx
\item ifthen
\item xargs
\item etoolbox
\end{itemize}

\section{What is missing?}
\label{sec-2}
\begin{itemize}
\item manually adding and editing legend entries
\item The look of the elements can be improved
\item More element types can be added
\item \ldots{}
\end{itemize}

\section{Known issues}
\label{sec-3}
I am not an \TeX{} programmer. I basically used the \tikzlabel{} commands and wrote a bunch of macros.
\begin{itemize}
\item no error handling implemented
\item no dedicated scoping of internal macros (use of lattice with documentclass standalone recommended)
\item legend entry alignment is buggy for some legend scales that differ significantly
  from~1
\item please report bugs!
\end{itemize}

\section{General Remarks}
\label{sec-6}
\begin{itemize}
\item it is recommended to draw lattices using \lstinline+\documentclass{standalone}+
  especially for larger beamlines.
\item There are 5 examples coming with this package. Some are shown in this document.
  Please look at the separate commented tex-files for the source code.
\item lengths are set in meter, so you write \{1.32\} for \SI{1.32}{\m}.
\item beamline with angle \SI{0}{\degree} goes to the right, positive angles bend counter clockwise.
\item settings (colors, font, rotatelabel,\ldots{}) changed within a \verb+scope+ environment are set back to the previous values outside of \verb+scope+
\item picture scale: for lattice scale=1 an element of 1m length is plotted with 2cm length
\end{itemize}

Below, the values after an equal sign are default values of optional arguments. E.g.
  \optiondef{scale}{1} indicates that the default value of \option{scale} is 1.



\section{The lattice Environment}
\label{sec-4}
\lstset{language=[LaTeX]TeX}

To draw a lattice just add
\begin{lstlisting}
\usepackage{lattice}
\end{lstlisting}
to your preambel and use the lattice environment with
\begin{lstlisting}
  \begin{lattice}[(*\optiondef{scale}{1}*)][(*\optiondef{tikz options}{}*)]
    ...
  \end{lattice}
\end{lstlisting}
The \lstinline+lattice+ environment contains a \lstinline+tikzpicture+ environment in
which the lattice is drawn using usual tikz commands. The \lstinline+lattice+ environment
has 2 optional arguments:
\begin{enumerate}
\item \optiondef{scale}{1} scales whole picture (default is 1).
\item \optiondef{tikz options}{} gives any options for the \lstinline+tikzpicture+ (e.g.
  overlay, default is none).
\end{enumerate}


\section{Within lattice Environment}
\label{sec-5}

\subsection{Elements}
\label{sec-5-1}
You draw an accelerator lattice by writing the following element commands one after the
other. White spaces and newlines are ignored. Usually you will use one \lstinline+drift+
and one other element alternately. The element names are self-explanatory:

\begin{lstlisting}
  \drift{(*\option{length/m}*)}[(*\optiondef{name}{}*)]
  \dipole{(*\option{name}*)}{(*\option{arc length/m}*)}{(*\option{bending angle/deg}*)}[(*\optiondef{type}{s}*)][(*\optiondef{thickness/m}{0.6}*)]
\end{lstlisting}
The \lstinline+dipole+ option \optiondef{type}{s} allows to select different dipole
shapes. It is shown in example 2. Possible values are:
\begin{itemize}
\item s for a sector magnet (entrance/exit surface 90 degree to beampipe)
\item br for a bend rectangle magnet (parallel entrance/exit surfaces)
\item r for a rectangle magnet
\end{itemize}
If you use any other letters, also the default (s) is used.

\begin{lstlisting}
  \quadrupole{(*\option{name}*)}{(*\option{length/m}*)}[(*\optiondef{thickness/m}{0.5}*)]
  \sextupole{(*\option{name}*)}{(*\option{length/m}*)}[(*\optiondef{thickness/m}{0.3}*)]
  \corrector{(*\option{name}*)}{(*\option{length/m}*)}[(*\optiondef{thickness/m}{0.25}*)]
  \kicker{(*\option{name}*)}{(*\option{length/m}*)}[(*\optiondef{thickness/m}{0.25}*)]
  \cavity{(*\option{name}*)}{(*\option{length/m}*)}[(*\optiondef{thickness/m}{0.45}*)]
  \solenoid{(*\option{name}*)}{(*\option{length/m}*)}[(*\optiondef{thickness/m}{0.2}*)]
  \beamdump{(*\option{name}*)}{(*\option{length/m}*)}[(*\optiondef{thickness/m}{0.5}*)]
  \source{(*\option{name}*)}{(*\option{length/m}*)}[(*\optiondef{thickness/m}{0.5}*)]
  \screen{(*\option{name}*)}[(*\optiondef{length/m}{0.2}*)]
  \valve{(*\option{name}*)}
  \marker{(*\option{name}*)}[(*\optiondef{length/m}{0.35}*)]
\end{lstlisting}
The \lstinline+marker+ is a line perpendicular to the beamline, e.g. to mark sections.

\begin{figure}[h]
  \centering
  \includegraphics[width=10cm]{example1_linear}
  \caption{Example 1}
  \label{fig:example1}
\end{figure}


\subsection{Orientation of the lattice}
\label{sec-5-2}

\begin{lstlisting}
  \start{(*\option{coordinate/m}*)}
\end{lstlisting}
sets starting point of the lattice. Use it before the first element. \option{coordinate/m}
is of form (x,y) or any tikz label, e.g. (mylabel.east) You can use this with
\lstinline+\savecoordinate+ (section \ref{sec:coords}) to connect lattices, but it is
recommended to do this via \lstinline+\goto+ (see below). Both are shown in example 3.

\begin{lstlisting}
  \rotate{(*\option{angle/deg}*)}
\end{lstlisting}
bends the beamline by the given angle.

\begin{lstlisting}
  \setangle{(*\option{angle/deg}*)}
\end{lstlisting}
sets the beamline angle to the given angle. The next element is drawn with beam axis in
this direction.

\begin{lstlisting}
  \goto{(*\option{coordinate name}*)}
\end{lstlisting}
sets current position and angle to values saved
with \lstinline+\savecoordinate+ (section \ref{sec:coords}).
Use this to connect lattices and draw injection, extraction or even a complete accelerator
facility. This is shown in example 3.



\subsection{Rule and Legend}
\label{sec:rule-legend}

\begin{lstlisting}
  \drawrule{(*\option{position/m}*)}[(*\optiondef{tick distance/m}{1}*)][(*\optiondef{scale}{1}*)][(*\optiondef{height/m}{0.1}*)]
\end{lstlisting}
draws a rule to visualize the size of the lattice. Coordinate is of form (x,y) or any tikz
label, e.g. (mylabel.east)

\begin{lstlisting}
  \legend{(*\option{position/m}*)}[(*\optiondef{scale}{1}*)]
\end{lstlisting}
draws a legend with all element types that occur in the lattice before this command.
The given \option{position/m} is north west (upper left corner) of the legend box.
The scale option scales the whole box including the text, which has the usual label
textsize if scale=1.

\begin{lstlisting}
  \completelegend{(*\option{position/m}*)}[(*\optiondef{scale}{1}*)]
\end{lstlisting}
is similar to \lstinline+\legend+, but shows all element types.


\clearpage
\begin{figure}[h]
  \centering
  % this is the ring from example 2, but plotted smaller (30%).
  % the element sizes (in meter) are the same - as the rule indicates.
  \begin{lattice}[0.3]
    \setlabelfont{\tiny}
    \begin{labeldistance}{0.3}
      \drift{1}
      \dipole{M1}{2}{45}
      \drift{1}
      \turnlabels
      \dipole{M2}{2}{45}
      \turnlabels
      \drift{1}
      \dipole{M3}{2}{45}
      \drift{1}
      \savecoordinate{myCoord1}[center]
      \dipole{M4}{2}{45}
      \drift{1}
      \dipole{M5}{2}{45}
      \drift{1}
      \dipole{M6}{2}{45}
      \drift{1}
      \savecoordinate{myCoord2}[center]
      \dipole{M7}{2}{45}
      \drift{1}
      \dipole{M8}{2}{45}
      \drawrule{(-2.5,-1)}[2]
    \end{labeldistance}
    % custom drawing using saved coordinates (to center of drifts)
    \draw[->, thick] (myCoord2) -- (myCoord1) node[midway,fill=white,rotate=20] {signal};
  \end{lattice}
\caption{From example 3}
\label{fig:fromexample3}
\end{figure}


\subsection{Labels}
\label{sec:labels}
Every element has a text label showing the given element name. The position and
orientation of the label is set automatically according to the current angle of the
beamline. Several commands to modify the labels manually are described below. If you want
to disable labels, leave the element names blank or set the label color (section \ref{sec:colors}) to your background color.

\begin{lstlisting}
  \turnlabels
\end{lstlisting}
moves labels to other side of elements (swap with marker labels)

\begin{lstlisting}
  \rotatelabels{(*\option{angle/deg}*)}[(*\optiondef{anchor}{}*)]
\end{lstlisting}
allows rotation of element labels.
The \optiondef{anchor}{} sets the center of rotation (north, center, south west,
\ldots{}). West corresponds to the labels first character. By default the anchor is set
automatically depending on the current angle of the beamline.

\begin{lstlisting}
  \begin{labeldistance}{(*\option{distance/m}*)}
    ...
  \end{labeldistance}
\end{lstlisting}
sets the distance of text labels to the element center for all elements within this
environment. Default is 0.35.

\begin{lstlisting}
  \setlabeldistance{(*\option{distance/m}*)}
  \resetlabeldistance
\end{lstlisting}
sets the distance of text labels to the element center for all following elements. the
reset command sets the default value. Default is 0.35.

\begin{lstlisting}
  \setlabelfont{(*\option{fontsize}*)}
\end{lstlisting}
sets the text label font size. Default is \lstinline+\normalsize+.



\subsubsection{Colors}
\label{sec:colors}
The colors can be changed at any point of the lattice. A setting is valid until the next
color command. The reset commands set the according default color. Use a \lstinline+scope+
environment to change a color for a section of a lattice.

\begin{lstlisting}
  \setlinecolor{(*\option{type}*)}{(*\option{color}*)}
  \resetlinecolor{(*\option{type}*)}
\end{lstlisting}
for \option{type} drift and marker.

\begin{lstlisting}
  \setelementcolor{(*\option{type}*)}{(*\option{color}*)}[(*\optiondef{gradient color}{white}*)]
  \resetelementcolor{(*\option{type}*)}
\end{lstlisting}
for all element types. Set \optiondef{gradient color}{white} equal to \option{color} to
"disable" the gradient.

\begin{lstlisting}
  \setlabelcolor{(*\option{color}*)}
\end{lstlisting}
for textlabels. Set to background color to hide text labels.


\begin{lstlisting}
  \begin{fade}[(*\optiondef{opacity}{0.25}*)]
    ...
  \end{fade}
\end{lstlisting}
 reduces the opacity of all elements within the environment and sets all colors to gray.
 So you can fade out regions of the lattice - e.g. for presentations.
 This can also be used to completely hide regions by setting \optiondef{opacity}{0.25} to zero.




\subsection{Access lattice Coordinates}
\label{sec:coords}
You can use element coordinates to draw anything you want using pgf/tikz. 

\begin{lstlisting}
  \savecoordinate{(*\option{name}*)}[(*\optiondef{position}{east}*)]
\end{lstlisting}
 saves the coordinate of the previous element to access it later. Position specifies the exact place of the element. East and center are available. East is always downstream.

\begin{itemize}
\item you can use all tikz/pgf commands within the lattice environment to draw anything.
\item You can use this to connect multiple beamlines \textbf{within a lattice environment} with
  \lstinline+\goto{name}+ (recommended, e.g. used for elsa in Figure \ref{fig:elsa}).
\item You can use this to connect \textbf{multiple lattice environments} with
  \lstinline+\start{name}+. Use the tikz overlay option.
\item see example 3.
\end{itemize}




\begin{figure}
\centering
\begin{subfigure}[b]{.45\textwidth}
\centering
 \begin{lattice}
    \rotate{90}
    \turnlabels %labels to the left
    \drift{0.5}
    \quadrupole{QF1}{0.3}
    \drift{0.2}
    \kicker{}{0.1}
    \drift{0.07}
    \quadrupole{QD2}{0.3}
    \drift{0.4}
    \setelementcolor{kicker}{cyan}
    \kicker{Septum}{0.5}
    \resetelementcolor{kicker}
    \savecoordinate{Septum}[center] %save to connect other beamline
    \drift{0.8}
    \kicker{}{0.1}
    \drift{0.37}
    \quadrupole{QD3}{0.2}
    \drift{0.17}
    \kicker{}{0.1}
    \drift{0.1}
    \sextupole{SF1}{0.2}
    \drift{0.27}
    \dipole{MB1}{0.2}{30}[s][0.4]
    \drift{0.2}
  \end{lattice}
  % 
  %now draw second lattice and connect them using the saved coordinate
  \begin{lattice}[1][overlay]
    \start{(Septum)}
    \rotate{70}
    \drift{0.6}
    \kicker{SS1}{0.2}
    \drift{0.2}
    \kicker{SSH1}{0.2}
    \drift{0.3}
    \dipole{M1}{0.2}{-30}[r][0.4]
    \begin{fade} %fade out this part
      \drift{0.2}
      \dipole{M2}{0.2}{50}[r][0.4]
      \drift{0.2}
      \dipole{M3}{0.2}{-20}[r][0.4]
      \drift{0.7}
    \end{fade}
    \legend{(-1,6.5)}
  \end{lattice}
 \caption{two lattice environments and start}
\end{subfigure}
%
\begin{subfigure}[b]{.45\textwidth}
  \centering
  \begin{lattice}
    \rotate{90}
    \turnlabels %labels to the left
    \drift{0.5}
    \quadrupole{QF1}{0.3}
    \drift{0.2}
    \kicker{}{0.1}
    \drift{0.07}
    \quadrupole{QD2}{0.3}
    \drift{0.4}
    \setelementcolor{kicker}{cyan}
    \kicker{Septum}{0.5}
    \resetelementcolor{kicker}
    \savecoordinate{Septum}[center] %save to connect other beamline
    \drift{0.8}
    \kicker{}{0.1}
    \drift{0.37}
    \quadrupole{QD3}{0.2}
    \drift{0.17}
    \kicker{}{0.1}
    \drift{0.1}
    \sextupole{SF1}{0.2}
    \drift{0.27}
    \dipole{MB1}{0.2}{30}[s][0.4]
    \drift{0.2}

    % now go back to saved coordinate and continue with another beamline
    \goto{Septum}
    \rotate{-20}
    \turnlabels %labels to the right
    \drift{0.6}
    \kicker{SS1}{0.2}
    \drift{0.2}
    \kicker{SSH1}{0.2}
    \drift{0.3}
    \dipole{M1}{0.2}{-30}[r][0.4]
    \begin{fade} %fade out this part
      \drift{0.2}
      \dipole{M2}{0.2}{50}[r][0.4]
      \drift{0.2}
      \dipole{M3}{0.2}{-20}[r][0.4]
      \drift{0.7}
    \end{fade}
    \legend{(0,6.5)}
  \end{lattice}
  \caption{one lattice environment and goto}
\end{subfigure}
\caption{From example 3: Two ways to connect lattices}
\label{fig:twoways}
\end{figure}

\end{document}